<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="Encuesta rápida: marca afirmaciones, ve tu porcentaje y comparte. Guarda resultados para estadísticas.">
  <title>Encuesta rápida</title>
  <style>
    :root {
      --accent: #0ea5e9; /* azul neutro */
      --bg: #f6f7f9;
      --card: #eef2f7;
      --card-border: #d6dee9;
      --ink: #111827;
      --muted: #6b7280;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; background:var(--bg); color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:16px}/* Cabecera neutra */
header.site{ text-align:center; padding:14px 12px 10px; background:#fff; border-radius:0 0 16px 16px; box-shadow:0 8px 24px rgba(0,0,0,.05) }
header h1{ margin:6px 0 4px; font-size:clamp(1.35rem,2.8vw,2rem) }
.lead{ text-align:center; color:var(--muted); margin:0 0 8px }

/* Barra superior fija: resultado + compartir + enviar */
.topbar{ position:sticky; top:0; z-index:20; display:flex; align-items:center; gap:12px; padding:8px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); margin:12px 0 }
.donut{ width:88px; height:88px }
.percent{ font-weight:800; font-size:clamp(1.3rem,4.5vw,2rem); line-height:1 }
.sub{ color:var(--muted); font-size:.92rem }
.badge{ font-weight:800 }

.actions{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
.btn{ border:0; background:var(--accent); color:#fff; padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer }
.btn.ghost{ background:#e5e7eb; color:#111827 }

/* Botón flotante móvil para compartir */
.share-fab{ position:fixed; right:14px; bottom:14px; z-index:30; display:none }
.share-fab .btn{ border-radius:999px; padding:12px 14px }
@media (max-width: 640px){ .share-fab{ display:block } }

/* Grid tarjetas */
.grid{ display:grid; gap:12px; grid-template-columns:repeat(1,minmax(0,1fr)) }
@media (min-width:640px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
@media (min-width:1024px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }

/* Tarjetas clicables: imagen + texto dentro del label */
.card{ display:flex; align-items:flex-start; gap:12px; background:var(--card); border:1px dashed var(--card-border); border-radius:14px; padding:12px 14px }
.card:hover{ border-style:solid }
.card input[type=checkbox]{ transform:scale(1.2); accent-color:var(--accent); margin-top:2px }
.card label.card-body{ display:flex; gap:8px; align-items:flex-start; cursor:pointer; width:100% }
.card label.card-body img{ width:44px; height:44px; object-fit:contain; flex:0 0 auto }
.card label.card-body span{ font-size:.95rem; line-height:1.3; display:block }

.controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:14px 0 }
.footer-note{ color:var(--muted); font-size:.9rem; text-align:center; padding:8px 0 16px }

  </style>
</head>
<body>
  <div class="container">
    <header class="site">
      <h1>Encuesta rápida</h1>
      <p class="lead">Marca con qué afirmaciones sueles coincidir. Cada una vale <strong>5%</strong>. El resultado y el compartir quedan siempre visibles.</p>
    </header><!-- Barra superior fija con donut + porcentaje + compartir + enviar -->
<div class="topbar" role="status" aria-live="polite">
  <svg class="donut" viewBox="0 0 120 120" aria-hidden="true">
    <circle cx="60" cy="60" r="52" fill="none" stroke="#eef3e7" stroke-width="12"></circle>
    <circle id="arc" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 327"></circle>
  </svg>
  <div>
    <div class="percent" id="percent">0%</div>
    <div class="sub"><span class="badge" id="facha">Facha: 0%</span></div>
  </div>
  <div class="actions">
    <button class="btn" id="share-native" title="Compartir">Compartir</button>
    <button class="btn ghost" id="copy-link" title="Copiar enlace">Copiar</button>
    <button class="btn ghost" id="reset" title="Borrar selecciones">Reiniciar</button>
    <button class="btn" id="send" title="Guardar respuestas">Enviar</button>
  </div>
</div>

<!-- Botón flotante (móvil) para compartir -->
<div class="share-fab"><button class="btn" id="share-fab">Compartir</button></div>

<form id="form" aria-describedby="ayuda">
  <div class="grid"><!-- tarjetas generadas por JS --></div>
</form>

<div class="controls">
  <button class="btn" id="send-bottom" title="Guardar respuestas">Enviar</button>
</div>

<div class="footer-note" id="ayuda">Cada afirmación marcada suma 5%. Total de 20 afirmaciones = 100%.</div>

  </div>  <script>
    // === CONFIGURACIÓN BACKEND ===
    // Sustituye por la URL de tu Web Service en Render, por ejemplo:
    // const API_BASE = 'https://tu-api.onrender.com';
    const API_BASE = (location.hostname==='localhost') ? 'http://localhost:3000' : 'https://encuesta-id5p.onrender.com';

    // === Ítems de la encuesta (20) ===
    const items = [
      "Creo que la ley no debe permitir partidos que busquen la ruptura de España",
      "Creo que en España se pagan demasiados impuestos",
      "Apoyo a los inmigrantes que vienen a integrarse",
      "Pienso que los ilegales deben ser devueltos a sus países",
      "No quiero en España culturas que denigran a la mujer",
      "Apoyo la prisión permanente para los violadores de mujeres",
      "Opino que hombres y mujeres no somos enemigos",
      "Creo que hay que reforzar la vigilancia en nuestras fronteras",
      "Pienso que los okupas deben ser expulsados de inmediato",
      "Apoyo nuestro producto e industria frente a la competencia desleal",
      "Hay que endurecer las penas para los criminales",
      "Apoyo que los padres elijan la educación de sus hijos",
      "Pienso que hay que conservar las tradiciones que nos unen",
      "Apoyo un Sistema Sanitario y Educativo público común en España",
      "Yo no me avergüenzo de mi bandera ni de ser español",
      "Las instituciones públicas deben reducir el gasto político",
      "Pienso que hay que garantizar la libertad de hablar en español",
      "No quiero hombres biológicos en el deporte femenino",
      "Creo que la Policía y la Guardia Civil deberían tener más medios",
      "Quiero que el bipartidismo deje de politizar la Justicia"
    ];

    // === Render de tarjetas ===
    const grid = document.querySelector('.grid');
    items.forEach((text, i) => {
      const id = `i${i+1}`;
      grid.insertAdjacentHTML('beforeend', `
        <div class="card">
          <input type="checkbox" id="${id}">
          <label class="card-body" for="${id}">
            <img src="img/${i+1}.png" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
            <span>${text}</span>
          </label>
        </div>
      `);
    });

    // === Donut y porcentaje ===
    const arc = document.getElementById('arc');
    const percentEl = document.getElementById('percent');
    const fachaEl = document.getElementById('facha');
    const form = document.getElementById('form');
    const resetBtn = document.getElementById('reset');
    const sendBtn = document.getElementById('send');
    const sendBottomBtn = document.getElementById('send-bottom');
    const btnShare = document.getElementById('share-native');
    const btnShareFab = document.getElementById('share-fab');
    const copyBtn = document.getElementById('copy-link');

    const radius = 52; const CIRC = 2 * Math.PI * radius; // ≈ 326.7

    function getCheckedCount(){ return form.querySelectorAll('input[type="checkbox"]:checked').length; }
    function getBits(){ return Array.from(form.querySelectorAll('input[type="checkbox"]')).map(c=>c.checked?'1':'0').join(''); }
    function setBits(bits){ const boxes=form.querySelectorAll('input[type="checkbox"]'); [...boxes].forEach((c,i)=> c.checked = bits[i]==='1'); }
    function update(){
      const checked = getCheckedCount();
      const perc = Math.min(checked*5,100);
      const dash = (perc/100)*CIRC;
      arc.setAttribute('stroke-dasharray', `${dash} ${CIRC}`);
      percentEl.textContent = `${perc}%`;
      fachaEl.textContent = `Facha: ${perc}%`;
      document.title = `Coincidencia ${perc}%`;
    }

    // URL con estado (?s=...)
    function encodeURL(){ const bits=getBits(); const url=new URL(window.location.href); url.searchParams.set('s', bits); history.replaceState(null,'',url.toString()); return url.toString(); }

    // Compartición (incluye porcentaje Facha)
    function getSharePayload(perc){ const url = encodeURL(); const text = `Mi porcentaje personal: ${perc}% — Facha: ${perc}%. Haz tu test:`; return { text, url }; }

    async function doShare(){
      const perc = Math.min(getCheckedCount()*5, 100);
      const { text, url } = getSharePayload(perc);
      if (navigator.share) { try { await navigator.share({ title: 'Encuesta rápida', text, url }); return; } catch(e){} }
      try { await navigator.clipboard.writeText(`${text} ${url}`); alert('Texto y enlace copiados para compartir'); } catch { alert(`${text} ${url}`); }
    }

    form.addEventListener('change', update);
    resetBtn.addEventListener('click', ()=>{ form.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); update(); history.replaceState({},'',window.location.pathname); });
    btnShare.addEventListener('click', doShare);
    btnShareFab.addEventListener('click', doShare);
    copyBtn.addEventListener('click', async()=>{ const url = encodeURL(); try{ await navigator.clipboard.writeText(url); alert('Enlace copiado'); } catch{ alert(url); } });

    // Restaurar desde URL si viene ?s=
    const initBits = new URL(location.href).searchParams.get('s'); if (initBits && initBits.length===20) setBits(initBits);
    update();

    // === Envío a BBDD ===
    async function submitAnswers(){
      const bits = getBits();
      const perc = Math.min(getCheckedCount()*5, 100);
      const body = { bits, percent: perc, user_agent: navigator.userAgent };
      try{
        const res = await fetch(`${API_BASE}/api/submit`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), keepalive: true });
        if(!res.ok) throw new Error('Error de envío');
        const data = await res.json();
        alert('¡Respuestas guardadas! Gracias.');
        return data;
      }catch(err){
        console.error(err);
        alert('No se pudo guardar. Si estás en hosting estático, despliega el backend.');
      }
    }

    sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitAnswers(); });
    sendBottomBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitAnswers(); });
  </script></body>
</html>
