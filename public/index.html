<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="Encuesta rápida: marca afirmaciones, ve tu porcentaje y comparte una imagen con tu resultado.">
  <title>Encuesta rápida</title>
  <style>
    :root { --accent:#0ea5e9; --bg:#f6f7f9; --card:#eef2f7; --card-border:#d6dee9; --ink:#111827; --muted:#6b7280; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; background:var(--bg); color:var(--ink); position:relative}
    body::after{ content:""; position:fixed; right:10px; bottom:10px; width:84px; height:56px; opacity:.15; z-index:0;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="3" height="2" viewBox="0 0 3 2"><rect width="3" height="2" fill="%23aa151b"/><rect y="0.5" width="3" height="1" fill="%23f1bf00"/></svg>');
      background-size:cover; background-repeat:no-repeat; pointer-events:none; }
    .container{max-width:1100px;margin:0 auto;padding:16px; position:relative; z-index:1}
    header.site{ text-align:center; padding:14px 12px 10px; background:#fff; border-radius:0 0 16px 16px; box-shadow:0 8px 24px rgba(0,0,0,.05) }
    header h1{ margin:6px 0 4px; font-size:clamp(1.35rem,2.8vw,2rem) }
    .lead{ text-align:center; color:var(--muted); margin:0 0 8px }

    .topbar{ position:sticky; top:0; z-index:20; display:flex; align-items:center; gap:12px; padding:8px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); margin:12px 0 }
    .donut{ width:88px; height:88px }
    .percent{ font-weight:800; font-size:clamp(1.3rem,4.5vw,2rem); line-height:1 }
    .sub{ color:var(--muted); font-size:.92rem }
    .badge{ font-weight:800 }
    .actions{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .btn{ border:0; background:var(--accent); color:#fff; padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer }
    .btn.ghost{ background:#e5e7eb; color:#111827 }

    .share-sticky{ position:sticky; bottom:0; z-index:15; margin-top:12px }
    .share-sticky .bar{ display:flex; gap:10px; justify-content:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    .share-sticky .btn{ padding:8px 12px }

    .grid{ display:grid; gap:12px; grid-template-columns:repeat(1,minmax(0,1fr)) }
    @media (min-width:640px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (min-width:1024px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }

    .card{ display:flex; align-items:flex-start; gap:12px; background:var(--card); border:1px dashed var(--card-border); border-radius:14px; padding:12px 14px }
    .card:hover{ border-style:solid }
    .card input[type=checkbox]{ transform:scale(1.2); accent-color:var(--accent); margin-top:2px }
    .card label.card-body{ display:flex; gap:8px; align-items:flex-start; cursor:pointer; width:100% }
    .card label.card-body img{ width:44px; height:44px; object-fit:contain; flex:0 0 auto }
    .card label.card-body span{ font-size:.95rem; line-height:1.3; display:block }

    .footer-note{ color:var(--muted); font-size:.9rem; text-align:center; padding:8px 0 16px }
  </style>
</head>
<body>
  <div class="container">
    <header class="site">
      <h1>Encuesta rápida</h1>
      <p class="lead">Marca con qué afirmaciones sueles coincidir. Cada una vale <strong>5%</strong>. Comparte tu resultado cuando quieras.</p>
    </header>

    <div class="topbar" role="status" aria-live="polite">
      <svg class="donut" viewBox="0 0 120 120" aria-hidden="true">
        <circle cx="60" cy="60" r="52" fill="none" stroke="#eef3e7" stroke-width="12"></circle>
        <circle id="arc" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 327"></circle>
      </svg>
      <div>
        <div class="percent" id="percent">0%</div>
        <div class="sub"><span class="badge" id="facha">Facha: 0%</span></div>
      </div>
      <div class="actions">
        <button class="btn" id="share-native" title="Compartir">Compartir</button>
        <button class="btn ghost" id="copy-link" title="Copiar enlace">Copiar</button>
        <button class="btn ghost" id="download-img" title="Descargar imagen">Descargar imagen</button>
        <button class="btn ghost" id="reset" title="Borrar selecciones">Reiniciar</button>
      </div>
    </div>

    <form id="form" aria-describedby="ayuda">
      <div class="grid"><!-- tarjetas generadas por JS --></div>
    </form>

    <div class="share-sticky">
      <div class="bar">
        <button class="btn" id="share-bottom" title="Compartir">Compartir</button>
        <button class="btn ghost" id="copy-bottom" title="Copiar enlace">Copiar</button>
        <button class="btn ghost" id="download-bottom" title="Descargar imagen">Descargar imagen</button>
      </div>
    </div>

    <div class="footer-note" id="ayuda">Cada afirmación marcada suma 5%. Total de 20 afirmaciones = 100%.</div>
  </div>

  <script>
    const API_BASE = ''; // mismo origen (servido por server.js)

    const items = [
      "Creo que la ley no debe permitir partidos que busquen la ruptura de España",
      "Creo que en España se pagan demasiados impuestos",
      "Apoyo a los inmigrantes que vienen a integrarse",
      "Pienso que los ilegales deben ser devueltos a sus países",
      "No quiero en España culturas que denigran a la mujer",
      "Apoyo la prisión permanente para los violadores de mujeres",
      "Opino que hombres y mujeres no somos enemigos",
      "Creo que hay que reforzar la vigilancia en nuestras fronteras",
      "Pienso que los okupas deben ser expulsados de inmediato",
      "Apoyo nuestro producto e industria frente a la competencia desleal",
      "Hay que endurecer las penas para los criminales",
      "Apoyo que los padres elijan la educación de sus hijos",
      "Pienso que hay que conservar las tradiciones que nos unen",
      "Apoyo un Sistema Sanitario y Educativo público común en España",
      "Yo no me avergüenzo de mi bandera ni de ser español",
      "Las instituciones públicas deben reducir el gasto político",
      "Pienso que hay que garantizar la libertad de hablar en español",
      "No quiero hombres biológicos en el deporte femenino",
      "Creo que la Policía y la Guardia Civil deberían tener más medios",
      "Quiero que el bipartidismo deje de politizar la Justicia"
    ];

    const grid = document.querySelector('.grid');
    items.forEach((text, i) => {
      const id = `i${i+1}`;
      grid.insertAdjacentHTML('beforeend', `
        <div class="card">
          <input type="checkbox" id="${id}">
          <label class="card-body" for="${id}">
            <img src="img/${i+1}.png" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
            <span>${text}</span>
          </label>
        </div>
      `);
    });

    const arc = document.getElementById('arc');
    const percentEl = document.getElementById('percent');
    const fachaEl = document.getElementById('facha');
    const form = document.getElementById('form');
    const resetBtn = document.getElementById('reset');
    const btnShareTop = document.getElementById('share-native');
    const btnShareBottom = document.getElementById('share-bottom');
    const copyTop = document.getElementById('copy-link');
    const copyBottom = document.getElementById('copy-bottom');
    const dlTop = document.getElementById('download-img');
    const dlBottom = document.getElementById('download-bottom');

    const radius = 52; const CIRC = 2*Math.PI*radius;

    function getCheckedCount(){ return form.querySelectorAll('input[type="checkbox"]:checked').length; }
    function getBits(){ return Array.from(form.querySelectorAll('input[type="checkbox"]')).map(c=>c.checked?'1':'0').join(''); }
    function setBits(bits){ const boxes = form.querySelectorAll('input[type="checkbox"]'); [...boxes].forEach((c,i)=> c.checked = bits[i]==='1'); }
    function update(){
      const checked = getCheckedCount();
      const perc = Math.min(checked*5,100);
      const dash = (perc/100)*CIRC;
      arc.setAttribute('stroke-dasharray', `${dash} ${CIRC}`);
      percentEl.textContent = `${perc}%`;
      fachaEl.textContent = `Facha: ${perc}%`;
      document.title = `Coincidencia ${perc}%`;
    }

    function encodeURL(){ const bits=getBits(); const url=new URL(window.location.href); url.searchParams.set('s', bits); history.replaceState(null,'',url.toString()); return url.toString(); }

    function drawShareCanvas(perc){
      const W=1200,H=630;
      const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);
      ctx.globalAlpha=.15; ctx.fillStyle='#aa151b'; ctx.fillRect(W-180,H-120,160,100);
      ctx.fillStyle='#f1bf00'; ctx.fillRect(W-180,H-120+25,160,50); ctx.globalAlpha=1;
      ctx.fillStyle='#111827'; ctx.font='bold 64px system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillText('Encuesta rápida',60,110);
      ctx.font='bold 80px system-ui, -apple-system, Segoe UI, Roboto'; const phrase=`Soy un ${perc}% facha, ¿y tú?`; ctx.fillText(phrase,60,240);
      const cx=220, cy=420, r=120, start=-Math.PI/2, end=start+(2*Math.PI)*(perc/100);
      ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=30; ctx.lineCap='round'; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();
      ctx.strokeStyle='#0ea5e9'; ctx.beginPath(); ctx.arc(cx,cy,r,start,end); ctx.stroke();
      ctx.fillStyle='#111827'; ctx.font='bold 72px system-ui, -apple-system, Segoe UI, Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(`${perc}%`,cx,cy);
      ctx.textAlign='left'; ctx.textBaseline='alphabetic'; ctx.font='32px system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillStyle='#6b7280'; ctx.fillText('Haz tu test y comparte tu resultado:', 60, 300);
      return canvas;
    }

    async function uploadImage(canvas){
      const blob = await new Promise(res=> canvas.toBlob(res,'image/png',0.95));
      const b64 = await new Promise((resolve)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result.split(',')[1]); r.readAsDataURL(blob); });
      const resp = await fetch(`${API_BASE}/api/share-image`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ image_base64: b64 }) });
      if(!resp.ok) throw new Error('upload_fail');
      return resp.json(); // { url }
    }

    async function logShare(perc){
      const bits=getBits();
      const body={ bits, percent: perc, user_agent: navigator.userAgent };
      try{ await fetch(`${API_BASE}/api/share`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), keepalive: true }); }catch(e){}
    }

    function getSharePayload(perc){ const url=encodeURL(); const text=`Soy un ${perc}% facha, ¿y tú?`; return { text, url }; }

    async function doShare(){
      const perc = Math.min(getCheckedCount()*5,100);
      await logShare(perc);
      const canvas = drawShareCanvas(perc);
      try{
        const blob = await new Promise(res=> canvas.toBlob(res,'image/png',0.95));
        const file = new File([blob], `resultado_${perc}.png`, { type:'image/png' });
        if (navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ title:'Encuesta rápida', text:`Soy un ${perc}% facha, ¿y tú?`, files:[file] });
          return;
        }
      }catch(e){}
      try{
        const { url: imgUrl } = await uploadImage(canvas);
        const { text, url } = getSharePayload(perc);
        const shareText = `${text} ${url} \nImagen: ${imgUrl}`;
        await navigator.clipboard.writeText(shareText);
        alert('Enlace e imagen copiados para compartir');
      }catch(e){
        const a=document.createElement('a'); a.download=`resultado_${perc}.png`; a.href=canvas.toDataURL('image/png'); a.click();
        alert('Imagen descargada. Compártela junto con el enlace.');
      }
    }

    function downloadImage(){
      const perc = Math.min(getCheckedCount()*5,100);
      const canvas = drawShareCanvas(perc);
      const a=document.createElement('a'); a.download=`resultado_${perc}.png`; a.href=canvas.toDataURL('image/png'); a.click();
    }

    form.addEventListener('change', update);
    resetBtn.addEventListener('click', ()=>{ form.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); update(); history.replaceState({},'',window.location.pathname); });
    btnShareTop.addEventListener('click', doShare);
    btnShareBottom.addEventListener('click', doShare);
    copyTop.addEventListener('click', async()=>{ const url=encodeURL(); try{ await navigator.clipboard.writeText(url); alert('Enlace copiado'); } catch{ alert(url); } });
    copyBottom.addEventListener('click', async()=>{ const url=encodeURL(); try{ await navigator.clipboard.writeText(url); alert('Enlace copiado'); } catch{ alert(url); } });
    dlTop.addEventListener('click', downloadImage);
    dlBottom.addEventListener('click', downloadImage);

    const initBits = new URL(location.href).searchParams.get('s'); if (initBits && initBits.length===20) setBits(initBits);
    update();
  </script>
</body>
</html>
