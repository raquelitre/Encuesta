<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#63AF2B" />
  <title>Encuesta rápida</title>
  <style>
    :root{
      --accent:#63AF2B;      /* verde */
      --bg:#f6f7f9;
      --card:#e7efd8;
      --card-border:#c8d6ae;
      --ink:#1b1b1b;
      --muted:#667085;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      background:var(--bg); color:var(--ink); position:relative;
    }
    /* Marca de agua pequeña en pantalla */
    body::after{content:"";position:fixed;right:10px;bottom:calc(10px + env(safe-area-inset-bottom));
      width:92px;height:60px;opacity:.18;z-index:0;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="3" height="2" viewBox="0 0 3 2"><rect width="3" height="2" fill="%23aa151b"/><rect y="0.5" width="3" height="1" fill="%23f1bf00"/></svg>');
      background-size:cover;background-repeat:no-repeat;pointer-events:none;}
    .container{max-width:1100px;margin:0 auto;padding:12px 14px 80px;position:relative;z-index:1}

    header.site{ text-align:center; padding:12px; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06) }
    header h1{ margin:4px 0 2px; font-size:clamp(1.25rem,4vw,2rem) }
    .lead{ color:var(--muted); margin:0 }

    /* Barra superior fija (sticky) */
    .topbar{ position:sticky; top:env(safe-area-inset-top); z-index:20;
      display:flex; align-items:center; gap:10px; padding:10px;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); margin:10px 0 }
    .donut{ width:74px; height:74px }
    .percent{ font-weight:800; font-size:clamp(1.15rem,5vw,1.8rem); line-height:1 }
    .sub{ color:var(--muted); font-size:.92rem }
    .badge{ font-weight:800 }
    .actions{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .btn{ border:0; background:var(--accent); color:#fff; padding:9px 11px; border-radius:12px; font-weight:700; cursor:pointer; line-height:1 }
    .btn.ghost{ background:#e5e7eb; color:#111827 }
    .btn.icon{ display:inline-flex; align-items:center; gap:6px; padding:9px 10px }
    .btn.icon svg{ width:18px; height:18px; display:block }
    .btn.x{  background:#000 }        /* X */
    .btn.wh{ background:#25D366 }     /* WhatsApp */
    .btn.tg{ background:#229ED9 }     /* Telegram */
    .btn.fb{ background:#1877F2 }     /* Facebook */
    .btn.ig{ background:#E4405F }     /* Instagram */

    /* Barra inferior fija (para móvil) */
    .share-sticky{
      position:fixed; left:0; right:0; bottom:0; z-index:25;
      padding:8px calc(10px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left));
      background:linear-gradient(180deg, rgba(246,247,249,0) 0%, rgba(246,247,249,1) 40%);
    }
    .share-sticky .bar{
      display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
      background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:8px; box-shadow:0 10px 30px rgba(0,0,0,.1)
    }
    .share-sticky .btn{ padding:10px 12px }

    /* Grid tarjetas */
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(1,minmax(0,1fr)) }
    @media (min-width:640px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (min-width:1024px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }

    .card{ display:flex; align-items:flex-start; gap:12px; background:var(--card); border:1px dashed var(--card-border);
      border-radius:14px; padding:12px 14px }
    .card:hover{ border-style:solid }
    .card input[type=checkbox]{ transform:scale(1.2); accent-color:var(--accent); margin-top:2px }
    .card label.card-body{ display:flex; gap:8px; align-items:flex-start; cursor:pointer; width:100% }
    .card label.card-body img{ width:44px; height:44px; object-fit:contain; flex:0 0 auto }
    .card label.card-body span{ font-size:1rem; line-height:1.35; display:block }

    .footer-note{ color:var(--muted); font-size:.92rem; text-align:center; padding:8px 0 90px }
  </style>
</head>
<body>
  <div class="container">
    <header class="site">
      <h1>Encuesta rápida</h1>
      <p class="lead">Marca con qué afirmaciones sueles coincidir. Cada una vale <strong>5%</strong>. Comparte tu resultado cuando quieras.</p>
    </header>

    <!-- Barra superior fija -->
    <div class="topbar" role="status" aria-live="polite">
      <svg class="donut" viewBox="0 0 120 120" aria-hidden="true">
        <circle cx="60" cy="60" r="52" fill="none" stroke="#eef3e7" stroke-width="12"></circle>
        <circle id="arc" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="12"
                stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 327"></circle>
      </svg>
      <div>
        <div class="percent" id="percent">0%</div>
        <div class="sub"><span class="badge" id="facha">Facha: 0%</span></div>
      </div>

      <div class="actions">
        <!-- Redes con iconos -->
        <button class="btn icon x"  id="share-x"  title="Compartir en X">
          <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3l18 18M21 3L3 21"></path>
          </svg> X
        </button>
        <button class="btn icon wh" id="share-wh" title="Compartir en WhatsApp">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M20.5 3.5A11 11 0 006.6 20.8L3 21l1-3.5A11 11 0 1020.5 3.5zm-1.9 14.7c-.3.9-1.6 1.5-2.6 1.7-.7.1-1.7.2-4-.9-3.4-1.5-5.5-4.9-5.6-5.1-.2-.3-1.3-1.7-1.3-3.3 0-1.6.8-2.4 1.1-2.8.3-.3.7-.4 1-.4h.7c.2 0 .5 0 .7.6.3.8 1 2.7 1.1 2.9.1.2.1.5 0 .7-.2.4-.5.7-.8 1-.2.1-.4.3-.2.7.2.4.9 1.5 1.9 2.4 1.3 1.2 2.4 1.6 2.8 1.8.3.1.6.1.8-.1.3-.4.9-1.1 1.1-1.5.3-.3.6-.3.9-.2.4.1 2.2 1 2.6 1.2.4.2.7.2.8.4.1.1.1.8-.2 1.5z"/></svg>
          WhatsApp
        </button>
        <button class="btn icon tg" id="share-tg" title="Compartir en Telegram">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M9.8 15.6l-.3 4.3c.4 0 .6-.2.8-.4l1.9-1.8 4.1 3c.7.4 1.2.2 1.4-.6l2.5-11.7c.2-.8-.3-1.1-1-.9L3.6 11.1c-.8.2-.8.7-.1.9l4.6 1.4 10.7-6.7-9 8.9z"/></svg>
          Telegram
        </button>
        <button class="btn icon fb" id="share-fb" title="Compartir en Facebook">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M13 22v-8h3l1-4h-4V7c0-1.1.3-2 2-2h2V1.1C16.7 1 15.4 1 14 1c-3 0-5 1.8-5 5v3H6v4h3v8h4z"/></svg>
          Facebook
        </button>
        <button class="btn icon ig" id="share-ig" title="Compartir en Instagram">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm10 2H7a3 3 0 00-3 3v10a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3zm-5 3a5 5 0 110 10 5 5 0 010-10zm0 2.2a2.8 2.8 0 100 5.6 2.8 2.8 0 000-5.6zM18.5 6a1 1 0 110 2 1 1 0 010-2z"/></svg>
          Instagram
        </button>

        <!-- Utilidades -->
        <button class="btn ghost" id="copy-link" title="Copiar enlace">Copiar</button>
        <button class="btn ghost" id="download-img" title="Descargar imagen">Descargar imagen</button>
        <button class="btn ghost" id="reset" title="Borrar selecciones">Reiniciar</button>
      </div>
    </div>

    <form id="form" aria-describedby="ayuda">
      <div class="grid" id="grid"><!-- tarjetas generadas por JS --></div>
    </form>

    <!-- Barra inferior fija (siempre visible en móvil) -->
    <div class="share-sticky">
      <div class="bar">
        <button class="btn icon x"  id="share-x-btm"  title="Compartir en X">
          <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3l18 18M21 3L3 21"></path>
          </svg> X
        </button>
        <button class="btn icon wh" id="share-wh-btm" title="Compartir en WhatsApp">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M20.5 3.5A11 11 0 006.6 20.8L3 21l1-3.5A11 11 0 1020.5 3.5zm-1.9 14.7c-.3.9-1.6 1.5-2.6 1.7-.7.1-1.7.2-4-.9-3.4-1.5-5.5-4.9-5.6-5.1-.2-.3-1.3-1.7-1.3-3.3 0-1.6.8-2.4 1.1-2.8.3-.3.7-.4 1-.4h.7c.2 0 .5 0 .7.6.3.8 1 2.7 1.1 2.9.1.2.1.5 0 .7-.2.4-.5.7-.8 1-.2.1-.4.3-.2.7.2.4.9 1.5 1.9 2.4 1.3 1.2 2.4 1.6 2.8 1.8.3.1.6.1.8-.1.3-.4.9-1.1 1.1-1.5.3-.3.6-.3.9-.2.4.1 2.2 1 2.6 1.2.4.2.7.2.8.4.1.1.1.8-.2 1.5z"/></svg>
          WhatsApp
        </button>
        <button class="btn icon tg" id="share-tg-btm" title="Compartir en Telegram">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M9.8 15.6l-.3 4.3c.4 0 .6-.2.8-.4l1.9-1.8 4.1 3c.7.4 1.2.2 1.4-.6l2.5-11.7c.2-.8-.3-1.1-1-.9L3.6 11.1c-.8.2-.8.7-.1.9l4.6 1.4 10.7-6.7-9 8.9z"/></svg>
          Telegram
        </button>
        <button class="btn icon fb" id="share-fb-btm" title="Compartir en Facebook">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M13 22v-8h3l1-4h-4V7c0-1.1.3-2 2-2h2V1.1C16.7 1 15.4 1 14 1c-3 0-5 1.8-5 5v3H6v4h3v8h4z"/></svg>
          Facebook
        </button>
        <button class="btn icon ig" id="share-ig-btm" title="Compartir en Instagram">
          <svg viewBox="0 0 24 24" fill="#fff"><path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm10 2H7a3 3 0 00-3 3v10a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3zm-5 3a5 5 0 110 10 5 5 0 010-10zm0 2.2a2.8 2.8 0 100 5.6 2.8 2.8 0 000-5.6zM18.5 6a1 1 0 110 2 1 1 0 010-2z"/></svg>
          Instagram
        </button>
        <button class="btn ghost" id="copy-bottom">Copiar</button>
        <button class="btn ghost" id="download-bottom">Descargar imagen</button>
      </div>
    </div>

    <div class="footer-note" id="ayuda">
      Cada afirmación marcada suma 5%. Total de 20 afirmaciones = 100%.
    </div>
  </div>

  <script>
    const API_BASE = '';
    const SITE_URL = location.origin;

    /* Ítems */
    const items = [
      "Creo que la ley no debe permitir partidos que busquen la ruptura de España",
      "Creo que en España se pagan demasiados impuestos",
      "Apoyo a los inmigrantes que vienen a integrarse",
      "Pienso que los ilegales deben ser devueltos a sus países",
      "No quiero en España culturas que denigran a la mujer",
      "Apoyo la prisión permanente para los violadores de mujeres",
      "Opino que hombres y mujeres no somos enemigos",
      "Creo que hay que reforzar la vigilancia en nuestras fronteras",
      "Pienso que los okupas deben ser expulsados de inmediato",
      "Apoyo nuestro producto e industria frente a la competencia desleal",
      "Hay que endurecer las penas para los criminales",
      "Apoyo que los padres elijan la educación de sus hijos",
      "Pienso que hay que conservar las tradiciones que nos unen",
      "Apoyo un Sistema Sanitario y Educativo público común en España",
      "Yo no me avergüenzo de mi bandera ni de ser español",
      "Las instituciones públicas deben reducir el gasto político",
      "Pienso que hay que garantizar la libertad de hablar en español",
      "No quiero hombres biológicos en el deporte femenino",
      "Creo que la Policía y la Guardia Civil deberían tener más medios",
      "Quiero que el bipartidismo deje de politizar la Justicia"
    ];

    /* Render del grid con try/catch para que nunca se rompa */
    (function renderGrid(){
      try{
        const grid = document.getElementById('grid');
        items.forEach((text, i) => {
          const id = `i${i+1}`;
          grid.insertAdjacentHTML('beforeend', `
            <div class="card">
              <input type="checkbox" id="${id}">
              <label class="card-body" for="${id}">
                <img src="img/${i+1}.png" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
                <span>${text}</span>
              </label>
            </div>
          `);
        });
      }catch(e){ console.error(e); }
    })();

    /* Donut y % */
    const arc = document.getElementById('arc');
    const percentEl = document.getElementById('percent');
    const fachaEl = document.getElementById('facha');
    const form = document.getElementById('form');
    const resetBtn = document.getElementById('reset');
    const radius = 52; const CIRC = 2*Math.PI*radius;

    function getCheckedCount(){ return form.querySelectorAll('input[type="checkbox"]:checked').length; }
    function getBits(){ return Array.from(form.querySelectorAll('input[type="checkbox"]')).map(c=>c.checked?'1':'0').join(''); }
    function setBits(bits){ const boxes=form.querySelectorAll('input[type="checkbox"]'); [...boxes].forEach((c,i)=> c.checked = bits[i]==='1'); }
    function update(){
      const checked = getCheckedCount();
      const perc = Math.min(checked*5,100);
      const dash = (perc/100)*CIRC;
      arc.setAttribute('stroke-dasharray', `${dash} ${CIRC}`);
      percentEl.textContent = `${perc}%`;
      fachaEl.textContent = `Facha: ${perc}%`;
      document.title = `Coincidencia ${perc}%`;
    }

    function encodeURL(){ const bits=getBits(); const url=new URL(window.location.href); url.searchParams.set('s', bits); history.replaceState(null,'',url.toString()); return url.toString(); }

    /* Imagen con fondo de BANDERA completa */
    function drawShareCanvas(perc){
      const W=1200,H=630;
      const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
      const ctx=canvas.getContext('2d');

      // Fondo bandera (rojo-amarillo-rojo)
      const stripe=H/3;
      ctx.fillStyle='#aa151b'; ctx.fillRect(0,0,W,stripe);
      ctx.fillStyle='#f1bf00'; ctx.fillRect(0,stripe,W,stripe);
      ctx.fillStyle='#aa151b'; ctx.fillRect(0,2*stripe,W,stripe);

      // Título
      ctx.fillStyle='#ffffff';
      ctx.font='bold 64px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.fillText('Encuesta rápida',60,110);

      // Mensaje principal
      ctx.fillStyle='#111827';
      ctx.font='bold 80px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.fillText(`Soy un ${perc}% facha, ¿y tú?`,60,240);

      // Donut
      const cx=220, cy=420, r=120, start=-Math.PI/2, end=start+(2*Math.PI)*(perc/100);
      ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=30; ctx.lineCap='round';
      ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();
      ctx.strokeStyle='#63AF2B';
      ctx.beginPath(); ctx.arc(cx,cy,r,start,end); ctx.stroke();

      // % dentro
      ctx.fillStyle='#111827';
      ctx.font='bold 72px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(`${perc}%`,cx,cy);

      // URL
      ctx.textAlign='left'; ctx.textBaseline='alphabetic';
      ctx.font='32px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillStyle='#000';
      ctx.fillText('Realiza tu encuesta aquí:',60,300);
      ctx.font='bold 36px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(SITE_URL,60,340);

      return canvas;
    }

    async function canvasToBase64(canvas){
      const blob = await new Promise(res=> canvas.toBlob(res,'image/png',0.95));
      return await new Promise(resolve=>{ const r=new FileReader(); r.onload=()=>resolve(r.result.split(',')[1]); r.readAsDataURL(blob);});
    }
    async function uploadImage(canvas){
      const image_base64 = await canvasToBase64(canvas);
      const resp = await fetch(`${API_BASE}/api/share-image`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ image_base64 }) });
      if(!resp.ok) throw new Error('upload_fail');
      return resp.json(); // { url }
    }
    async function logShare(perc){
      const bits=getBits();
      try{ await fetch(`${API_BASE}/api/share`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bits, percent: perc, user_agent: navigator.userAgent }), keepalive:true }); }catch(_){}
    }

    function buildShareText(perc, pageUrl, imgUrl){
      const t1 = `Soy un ${perc}% facha, ¿y tú?`;
      const t2 = `Realiza tu encuesta aquí: ${pageUrl}`;
      return imgUrl ? `${t1}\n${t2}\nImagen: ${imgUrl}` : `${t1}\n${t2}`;
    }

    async function shareTo(network){
      try{
        const perc = Math.min(getCheckedCount()*5,100);
        await logShare(perc);
        const pageUrl = encodeURL();
        const canvas = drawShareCanvas(perc);

        // Web Share con archivo (X/Instagram pueden aparecer en el sheet si el SO lo soporta)
        try{
          const blob = await new Promise(res=> canvas.toBlob(res,'image/png',0.95));
          const file = new File([blob], `resultado_${perc}.png`, { type:'image/png' });
          if (navigator.canShare && navigator.canShare({ files:[file] }) && (network==='x' || network==='ig')){
            await navigator.share({ title:'Encuesta', text:`Soy un ${perc}% facha, ¿y tú? Realiza tu encuesta aquí: ${pageUrl}`, files:[file] });
            return;
          }
        }catch(_){}

        // Subir imagen (para X/WA/TG añadimos link de imagen). Instagram web no tiene intent oficial.
        let imgUrl = '';
        try{ imgUrl = (await uploadImage(canvas)).url; }catch(_){}

        const text = buildShareText(perc, pageUrl, imgUrl);
        const encText = encodeURIComponent(text);
        const encUrl  = encodeURIComponent(pageUrl);

        let href = pageUrl;
        if(network==='x')  href = `https://twitter.com/intent/tweet?text=${encText}`;
        if(network==='wh') href = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
        if(network==='tg') href = `https://t.me/share/url?url=${encUrl}&text=${encText}`;
        if(network==='fb') href = `https://www.facebook.com/sharer/sharer.php?u=${encUrl}`;
        if(network==='ig'){
          // Fallback Instagram: copiar texto y descargar imagen para publicar manualmente
          try{ await navigator.clipboard.writeText(text); }catch(_){}
          const a=document.createElement('a'); a.download=`resultado_${perc}.png`; a.href=canvas.toDataURL('image/png'); a.click();
          alert('Instagram no permite compartir directo desde la web. Te hemos copiado el texto y descargado la imagen para que la subas en tu app de Instagram.');
          return;
        }

        window.open(href, '_blank');
      }catch(e){
        console.error(e);
        alert('No se pudo abrir el diálogo de compartir. Inténtalo de nuevo.');
      }
    }

    function downloadImage(){
      const perc = Math.min(getCheckedCount()*5,100);
      const canvas = drawShareCanvas(perc);
      const a=document.createElement('a'); a.download=`resultado_${perc}.png`; a.href=canvas.toDataURL('image/png'); a.click();
    }

    /* Listeners */
    form.addEventListener('change', update);
    resetBtn.addEventListener('click', ()=>{ form.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); update(); history.replaceState({},'',window.location.pathname); });

    document.getElementById('share-x').addEventListener('click',  ()=>shareTo('x'));
    document.getElementById('share-wh').addEventListener('click', ()=>shareTo('wh'));
    document.getElementById('share-tg').addEventListener('click', ()=>shareTo('tg'));
    document.getElementById('share-fb').addEventListener('click', ()=>shareTo('fb'));
    document.getElementById('share-ig').addEventListener('click', ()=>shareTo('ig'));

    document.getElementById('share-x-btm').addEventListener('click',  ()=>shareTo('x'));
    document.getElementById('share-wh-btm').addEventListener('click', ()=>shareTo('wh'));
    document.getElementById('share-tg-btm').addEventListener('click', ()=>shareTo('tg'));
    document.getElementById('share-fb-btm').addEventListener('click', ()=>shareTo('fb'));
    document.getElementById('share-ig-btm').addEventListener('click', ()=>shareTo('ig'));

    document.getElementById('copy-link').addEventListener('click', async()=>{ const url=encodeURL(); try{ awai
